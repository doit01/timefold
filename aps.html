<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OEB4 æ™ºæ…§æ’äº§ç³»ç»Ÿ Pro</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --sidebar-w: 200px;
            --cell-w: 60px;
            --row-h: 50px;
            --header-h: 70px;
            --oeb4-color: #ff4d4f;
            --normal-color: #1890ff;
            --clean-color: #52c41a;
            --dark-bg: #001529;
        }

        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; margin: 0; background: #f0f2f5; overflow: hidden; }

        /* ç™»å½•æ¨¡å— */
        #loginOverlay { position: fixed; inset: 0; background: var(--dark-bg); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .login-box button { width: 100%; padding: 12px; background: #1890ff; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .navbar { height: var(--header-h); background: var(--dark-bg); color: white; display: flex; align-items: center; padding: 0 25px; gap: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); position: relative; z-index: 100; }
        .navbar select { padding: 8px; border-radius: 4px; background: #1f3a56; color: white; border: none; outline: none; }
        .user-tag { margin-left: auto; font-size: 14px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; }
        .btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; color: white; font-size: 13px; }

        /* æ ¸å¿ƒç”˜ç‰¹å›¾å®¹å™¨ - å”¯ä¸€æ»šåŠ¨æ¡ */
        .gantt-viewport {
            height: calc(100vh - var(--header-h));
            overflow: auto; /* å…¨å±€æ»šåŠ¨æ¡ */
            position: relative;
            background: white;
        }

        .gantt-table {
            display: inline-block; /* å…è®¸å†…éƒ¨æ’‘å¼€å®½åº¦ */
            min-width: 100%;
            position: relative;
            border-collapse: collapse;
        }

        /* ç²˜æ€§æ—¥æœŸè¡¨å¤´ (Top Sticky) */
        .date-header-row {
            display: flex;
            position: sticky;
            top: 0;
            z-index: 40; /* é«˜äºå·¦ä¾§å’Œå†…å®¹ */
            background: #fafafa;
        }

        /* ç²˜æ€§å·¦ä¸Šè§’ (Corner Sticky) */
        .corner-cell {
            width: var(--sidebar-w);
            height: 60px;
            background: #eee;
            position: sticky;
            top: 0;
            left: 0;
            z-index: 50; /* æœ€é«˜ä¼˜å…ˆçº§ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-right: 2px solid #ddd;
            border-bottom: 2px solid #ddd;
        }

        .date-cell {
            width: var(--cell-w);
            height: 60px;
            flex-shrink: 0;
            border-right: 1px solid #eee;
            border-bottom: 2px solid #ddd;
            text-align: center;
            font-size: 12px;
            padding-top: 10px;
            box-sizing: border-box;
        }

        /* ç»˜å›¾è¡Œ (Row) */
        .equip-row {
            display: flex;
            height: var(--row-h);
            position: relative;
        }

        /* ç²˜æ€§è®¾å¤‡åˆ— (Left Sticky) */
        .equip-name-cell {
            width: var(--sidebar-w);
            background: #fff;
            position: sticky;
            left: 0;
            z-index: 30;
            border-right: 2px solid #ddd;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            padding-left: 15px;
            font-size: 13px;
            font-weight: 500;
            box-sizing: border-box;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        /* ç½‘æ ¼èƒŒæ™¯æ ¼å­ */
        .grid-cell {
            width: var(--cell-w);
            flex-shrink: 0;
            border-right: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            box-sizing: border-box;
            cursor: cell;
        }
        .grid-cell:hover { background-color: #f9fbff; }

        /* ä»»åŠ¡æ¡ (ç»å¯¹å®šä½) */
        .task-bar {
            position: absolute;
            height: 36px;
            top: 7px;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 35; /* ä½äºç½‘æ ¼ä¹‹ä¸Šï¼Œç²˜æ€§åˆ—ä¹‹ä¸‹ */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            padding: 0 5px;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .task-bar .op { font-size: 9px; opacity: 0.8; }

        /* å¼¹çª— */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: 1000; }
        .modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 25px; border-radius: 8px; width: 340px;
            display: none; z-index: 1001; box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal h3 { margin-top: 0; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; color: #888; margin-bottom: 4px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>

<!-- ç™»å½• -->
<div id="loginOverlay">
    <div class="login-box">
        <h2>æ’äº§ç®¡æ§ç³»ç»Ÿç™»å½•</h2>
        <input type="text" id="username" placeholder="ç”¨æˆ·å" value="admin">
        <input type="password" id="password" placeholder="å¯†ç " value="123456">
        <button onclick="doLogin()">è¿›å…¥ç³»ç»Ÿ</button>
    </div>
</div>

<!-- å¯¼èˆª -->
<div class="navbar">
    <div style="font-size: 20px; font-weight: bold;">OEB4 æ’äº§æ™ºæ…§çœ‹æ¿</div>
    
    <div style="display:flex; align-items:center; gap:8px;">
        <span style="font-size:14px;">è½¦é—´ç­›é€‰:</span>
        <select id="wsFilter" onchange="loadWorkshop()"></select>
    </div>

    <button class="btn" style="background:#52c41a" onclick="doExport()">å¯¼å‡º EXCEL</button>
    <button class="btn" style="background:#ff4d4f; font-size:10px;" onclick="doReset()">æ•°æ®é‡ç½®</button>

    <div class="user-tag" id="userDisplay">æœªç™»å½•</div>
</div>

<!-- ç”˜ç‰¹å›¾å†…å®¹åŒº -->
<div class="gantt-viewport" id="ganttViewport">
    <div class="gantt-table" id="ganttTable">
        <!-- ç¬¬ä¸€è¡Œï¼šç²˜æ€§æ—¥æœŸå¤´ -->
        <div class="date-header-row" id="dateHeaderRow">
            <div class="corner-cell">è®¾å¤‡åç§° \ æ—¥æœŸ</div>
            <!-- æ—¥æœŸå•å…ƒæ ¼åŠ¨æ€æ³¨å…¥ -->
        </div>
        <!-- è®¾å¤‡è¡ŒåŠ¨æ€æ³¨å…¥ -->
        <div id="equipRowsContainer"></div>
    </div>
</div>

<!-- å¼¹çª— -->
<div class="overlay" id="overlay" onclick="closeModal()"></div>
<div class="modal" id="taskModal">
    <h3 id="modalTitle">ä»»åŠ¡æ’äº§</h3>
    <input type="hidden" id="editId">
    <div class="form-group">
        <label>ä»»åŠ¡åç§°/æ‰¹å·</label>
        <input type="text" id="taskName">
    </div>
    <div class="form-group" style="display:flex; gap:10px;">
        <div style="flex:1"><label>å¼€å§‹æ—¥æœŸ</label><input type="date" id="taskStart"></div>
        <div style="flex:1"><label>ç”Ÿäº§å¤©æ•°</label><input type="number" id="taskDays" min="1"></div>
    </div>
    <div class="form-group">
        <label>é¡¹ç›®ç±»å‹</label>
        <select id="taskType">
            <option value="normal">æ™®é€šé¡¹ç›®</option>
            <option value="oeb4">OEB4é«˜æ´»æ€§</option>
            <option value="clean">è®¾å¤‡æ¸…åœº</option>
        </select>
    </div>
    <div style="font-size:11px; color:#999; margin-bottom:15px;">æ“ä½œäºº: <span id="opLabel"></span></div>
    <div class="btn-group">
        <button class="btn" id="btnDel" style="background:#ff4d4f; display:none" onclick="delTask()">åˆ é™¤</button>
        <button class="btn" style="background:#eee; color:#333" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn" style="background:#1890ff; flex:2" onclick="saveTask()">ä¿å­˜è®¡åˆ’</button>
    </div>
</div>

<script>
    // 1. åˆå§‹åŒ– 150 å°è®¾å¤‡
    const workshops = Array.from({length:10}, (_, i) => `è½¦é—´ ${String(i+1).padStart(2,'0')}`);
    const allEquips = [];
    workshops.forEach(ws => {
        for(let i=1; i<=15; i++) {
            allEquips.push({ id: `E-${ws}-${i}`, name: `${ws}-è®¾å¤‡${i}`, ws: ws });
        }
    });

    let tasks = JSON.parse(localStorage.getItem('gantt_final_db')) || [];
    let currentUser = '';
    const startDateBase = new Date(); startDateBase.setHours(0,0,0,0);

    // 2. ç™»å½•
    function doLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        if(u === 'admin' && p === '123456') {
            currentUser = u;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userDisplay').innerText = 'ğŸ‘¤ å½“å‰è´¦å·: ' + u;
            init();
        } else alert('è´¦å·å¯†ç ä¸å¯¹');
    }

    // 3. é¡µé¢åˆå§‹åŒ–
    function init() {
        const filter = document.getElementById('wsFilter');
        workshops.forEach(w => {
            const opt = document.createElement('option');
            opt.value = w; opt.innerText = w;
            filter.appendChild(opt);
        });

        // æ¸²æŸ“æ—¥æœŸå¤´
        const headerRow = document.getElementById('dateHeaderRow');
        for(let i=0; i<365; i++) {
            const d = new Date(startDateBase); d.setDate(d.getDate() + i);
            const cell = document.createElement('div');
            cell.className = 'date-cell';
            if(d.getDay()===0||d.getDay()===6) cell.style.background = '#f5f5f5';
            cell.innerHTML = `${d.getMonth()+1}/${d.getDate()}<br><small>${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d.getDay()]}</small>`;
            headerRow.appendChild(cell);
        }
        loadWorkshop();
    }

    // 4. è½¦é—´åŠ è½½ (æ ¸å¿ƒå¸ƒå±€é‡æ’)
    function loadWorkshop() {
        const activeWs = document.getElementById('wsFilter').value;
        const container = document.getElementById('equipRowsContainer');
        container.innerHTML = '';

        const filtered = allEquips.filter(e => e.ws === activeWs);
        filtered.forEach((eq, idx) => {
            const row = document.createElement('div');
            row.className = 'equip-row';
            row.id = 'row-' + eq.id;

            // ç²˜æ€§åç§°åˆ—
            const nameCell = document.createElement('div');
            nameCell.className = 'equip-name-cell';
            nameCell.innerText = eq.name;
            row.appendChild(nameCell);

            // 365ä¸ªç½‘æ ¼èƒŒæ™¯
            for(let j=0; j<365; j++) {
                const g = document.createElement('div');
                g.className = 'grid-cell';
                g.onclick = (e) => openTaskModal(eq.id, j);
                row.appendChild(g);
            }
            container.appendChild(row);
        });
        renderTasks();
    }

    // 5. ä»»åŠ¡æ¸²æŸ“
    function renderTasks() {
        document.querySelectorAll('.task-bar').forEach(b => b.remove());
        const activeWs = document.getElementById('wsFilter').value;
        const wsEquips = allEquips.filter(e => e.ws === activeWs);
        const wsEquipIds = wsEquips.map(e => e.id);

        tasks.forEach(t => {
            if(!wsEquipIds.includes(t.eqId)) return;

            const row = document.getElementById('row-' + t.eqId);
            const startD = new Date(t.start);
            const endD = new Date(t.end);
            const diffS = Math.round((startD - startDateBase) / 86400000);
            const duration = Math.round((endD - startD) / 86400000) + 1;

            if(diffS + duration < 0 || diffS > 365) return;

            const bar = document.createElement('div');
            bar.className = 'task-bar';
            bar.innerHTML = `<span>${t.name}</span><span class="op">ğŸ‘¤ ${t.op}</span>`;
            
            if(t.type==='oeb4') bar.style.background = 'var(--oeb4-color)';
            else if(t.type==='clean') bar.style.background = 'var(--clean-color)';
            else bar.style.background = 'var(--normal-color)';

            // ä½ç½®è®¡ç®—ï¼šå·¦åç§» = ä¾§è¾¹æ å®½ + (å¤©æ•° * æ ¼å­å®½)
            bar.style.left = `calc(var(--sidebar-w) + ${diffS * 60 + 2}px)`;
            bar.style.width = (duration * 60 - 4) + 'px';
            
            bar.onclick = (e) => { e.stopPropagation(); editTask(t.id); };
            row.appendChild(bar);
        });
    }

    // 6. å¼¹çª—é€»è¾‘
    function openTaskModal(eqId, dayIdx) {
        const d = new Date(startDateBase); d.setDate(d.getDate() + dayIdx);
        document.getElementById('editId').value = '';
        document.getElementById('taskName').value = '';
        document.getElementById('taskStart').value = d.toISOString().split('T')[0];
        document.getElementById('taskDays').value = 1;
        document.getElementById('taskModal').dataset.eqId = eqId;
        document.getElementById('btnDel').style.display = 'none';
        document.getElementById('opLabel').innerText = currentUser;
        
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('taskModal').style.display = 'block';
    }

    function editTask(id) {
        const t = tasks.find(x => x.id === id);
        document.getElementById('editId').value = t.id;
        document.getElementById('taskName').value = t.name;
        document.getElementById('taskStart').value = t.start;
        document.getElementById('taskType').value = t.type;
        document.getElementById('opLabel').innerText = t.op;
        
        const s = new Date(t.start); const e = new Date(t.end);
        document.getElementById('taskDays').value = Math.round((e-s)/86400000)+1;
        
        document.getElementById('taskModal').dataset.eqId = t.eqId;
        document.getElementById('btnDel').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('taskModal').style.display = 'block';
    }

    function saveTask() {
        const id = document.getElementById('editId').value;
        const startStr = document.getElementById('taskStart').value;
        const days = parseInt(document.getElementById('taskDays').value);
        const startD = new Date(startStr);
        const endD = new Date(startD); endD.setDate(startD.getDate() + days - 1);

        const data = {
            id: id ? parseInt(id) : Date.now(),
            name: document.getElementById('taskName').value || 'æœªå‘½åæ‰¹æ¬¡',
            start: startStr,
            end: endD.toISOString().split('T')[0],
            type: document.getElementById('taskType').value,
            eqId: document.getElementById('taskModal').dataset.eqId,
            op: currentUser
        };

        if(id) tasks = tasks.map(x => x.id === data.id ? data : x);
        else tasks.push(data);

        localStorage.setItem('gantt_final_db', JSON.stringify(tasks));
        renderTasks();
        closeModal();
    }

    function delTask() {
        const id = parseInt(document.getElementById('editId').value);
        if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
            tasks = tasks.filter(x => x.id !== id);
            localStorage.setItem('gantt_final_db', JSON.stringify(tasks));
            renderTasks();
            closeModal();
        }
    }

    function closeModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('taskModal').style.display = 'none';
    }

    // 7. å¯¼å‡º Excel
    function doExport() {
        const exportData = tasks.map(t => {
            const eq = allEquips.find(e => e.id === t.eqId);
            return {
                'è½¦é—´': eq.ws,
                'è®¾å¤‡': eq.name,
                'æ‰¹æ¬¡/ä»»åŠ¡': t.name,
                'å¼€å§‹æ—¥æœŸ': t.start,
                'ç»“æŸæ—¥æœŸ': t.end,
                'é£é™©ç±»å‹': t.type==='oeb4'?'é«˜æ´»æ€§':(t.type==='clean'?'æ¸…åœº':'æ™®é€š'),
                'æœ€åæ“ä½œäºº': t.op
            };
        });
        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç”Ÿäº§è®¡åˆ’");
        XLSX.writeFile(wb, `æ’äº§è¡¨_${new Date().toLocaleDateString()}.xlsx`);
    }

    function doReset() { if(confirm('é‡ç½®å°†åˆ é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼')) { tasks = []; localStorage.clear(); location.reload(); } }
</script>

</body>
</html>